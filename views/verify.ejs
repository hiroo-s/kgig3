<!DOCTYPE html>
<html lang="ja">

<head>
    <title>DIDチケット</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes">
    <link rel="stylesheet" href="/stylesheets/did-wg-poc.css">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
    <body>

        <div class="my_Container">

            <div class="my_Box-BackImage" style="background-image: url('/images/kamata-gig.png');"">
                <h1>KAMATA GIG III</h1>
            </div>

            <div class="my_Box-Center">

                <div class="my_Box" style="width: 90%;">
                    <h3>デジタルチケットを提示してチェックインしてください</h3>
                    <div class="my_Box-Center">
                        <div id="qrcode" style="width: 300px; height:auto; box-shadow: 0 10px 10px rgba(0, 0, 0, 0.3);"></div>
                    </div>
                </div>
            </div>

            <div class="my_Box-Note">
                <span class="box-title">チェックイン手順</span>
                <ol>
                    <li>表示された QR コードを長押しして「Authenticator で開く」を選択して Microsoft Authenticatorアプリを起動</li>
                    <li>「クレデンシャル検証者と共有しますか？」と表示されたら、「共有」ボタンをタップしてデジタルチケットを提示</li>
                    <li>スマホ画面に「要求は承認されました」のメッセージが出力されたらブラウザに戻る</li>
                    <li>受付完了のメッセージとともに「ドリンクチケット受け取り」のフォームが表示されるので、受付担当に見せながらボタンを押してドリンクチケットを受け取ってください</li>
                </ol>
            </div>

            <div class="my_Box-Center">
                <small>Copyright (c) IIJ did-wg All Rights Reserved.</small>
            </div>

        </div>
    </body>
    <script>
        let interval;
        let count = 300;
        function checkStatus() {
            count--;
            if (count < 0) {
                clearInterval(interval);
                location.href = "/verify";
            }
            // ２秒ごとに fetch する
            if (count % 2) {
                return;
            }
            fetch("/chk")
            .then(response => response.text())
            .catch(error => { console.log(error) })
            .then(response => {
                if (response == "OK") {
                    location.href = "/verified";
                } else if (response != "NG") {
                    console.log(response);
                    location.href = "/verified";
                }
            });
        }
        url = "openid-vc://?request_uri=<%= domain %>vp/<%= uuid %>";
        let qr = document.getElementById("qrcode");
        new QRCode(qr, url);
        interval = setInterval(checkStatus, 1000);
        if (/iPhone/i.test(navigator.userAgent)) {
            window.location.replace(url);
        } else if (/Android/i.test(navigator.userAgent)) {
            window.location.href = url;
        }
    </script>
</html>
