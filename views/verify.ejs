<!DOCTYPE html>
<html lang="ja">

<head>
    <title>DIDチケット</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes">
    <link rel="stylesheet" href="/stylesheets/did-wg-poc.css">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
    <body>

        <div class="my_Container">

            <div class="my_Box-BackImage" style="background-image: url('/images/kamata-gig.png');"">
                <h1>KAMATA GIG III</h1>
            </div>

            <div class="my_Box-Center">

                <div class="my_Box" style="width: 90%;"">
                    <h3>AuthenticatorでQRコードを読み取ってください</h3>
                    <div class="my_Box-Center">
                        <div id="qrcode"></div>
                    </div>
                </div>
            </div>

            <div class="my_Box-Note">
                <span class="box-title">デジタルチケット保存手順</span>
                <ol>
                    <li>Microsoft Authenticatorアプリを起動</li>
                    <li>下部ナビゲーションバーの右アイコン「検証済みID」をタップ</li>
                    <li>上部アプリバーの右アイコンをタップしてカメラを起動</li>
                    <li>上記で表示されたQRコードを 3. で起動したカメラで読み込み</li>
                    <li>デジタルチケットがダウンロードされるので保存</li>
                </ol>
                <p>＜Authenticator操作画面説明＞</p>
                <p style="margin-left: 1em;">下部ナビゲーションバーの右アイコン（検証済みID）</p>
                <p style="margin-left: 2em;"><img src="/images/vcicon.png" alt="下部ナビゲーションバーの右アイコン" style="width: 285px; height:auto; box-shadow: 0 10px 10px rgba(0, 0, 0, 0.3);"></p>
                <p style="margin-left: 1em;">上部アプリバーの右アイコン</p>
                <p style="margin-left: 2em;"><img src="/images/readericon.png" alt="上部アプリバーの右アイコン" style="width: 285px; height:auto; box-shadow: 0 10px 10px rgba(0, 0, 0, 0.3);"></p>

            </div>


            <div class="my_Box-Center">
                <small>Copyright (c) IIJ did-wg All Rights Reserved.</small>
            </div>

        </div>
    </body>
    <script>
        let interval;
        let count = 300;
        function checkStatus() {
            count--;
            if (count < 0) {
                clearInterval(interval);
                location.href = "/verify";
            }
            // ２秒ごとに fetch する
            if (count % 2) {
                return;
            }
            fetch("/chk")
            .then(response => response.text())
            .catch(error => { console.log(error) })
            .then(response => {
                if (response == "OK") {
                    location.href = "/verified";
                } else if (response != "NG") {
                    console.log(response);
                    location.href = "/verified";
                }
            });
        }
        url = "openid-vc://?request_uri=<%= domain %>vp/<%= uuid %>";
        let qr = document.getElementById("qrcode");
        new QRCode(qr, url);
        interval = setInterval(checkStatus, 1000);
        if (/iPhone/i.test(navigator.userAgent)) {
            window.location.replace(url);
        } else if (/Android/i.test(navigator.userAgent)) {
            window.location.href = url;
        }
    </script>
</html>